# API Endpoints Analysis

## Анализ работы API endpoints между фронтендом и бэкендом

### 1. POST /api/bookings (Создание бронирования)

**Фронтенд отправляет:**
```json
{
  "phone_number": "+998901234567",
  "barber_id": 1,  // или число из формы
  "service_ids": [1, 2],  // массив ID сервисов (игнорируется)
  "date": "2026-01-27",
  "time": "10:00",
  "client_name": "Имя клиента"
}
```

**Бэкенд обрабатывает:**
- ✅ Нормализует `barber_id` (конвертирует строку в число, обрабатывает пустые значения)
- ✅ Валидирует формат даты (YYYY-MM-DD) и времени (HH:MM)
- ✅ Если `barber_id` не указан или невалиден, использует default доктора
- ✅ Игнорирует `service_ids` (все бронирования фиксированные 30 минут)
- ✅ Создает или находит клиента по телефону
- ✅ Проверяет доступность временного слота
- ✅ Отправляет уведомление в Telegram если у клиента есть `tg_id`

**Исправления:**
- ✅ Улучшена нормализация данных (обработка пустых строк, NaN)
- ✅ Добавлено подробное логирование для отладки
- ✅ Улучшены сообщения об ошибках валидации

---

### 2. GET /api/bookings (Получение всех бронирований)

**Фронтенд:**
- Требует авторизацию (Bearer token)
- Используется в админ-панели

**Бэкенд:**
- ✅ Проверяет авторизацию
- ✅ Возвращает все бронирования с клиентами и докторами
- ✅ Упорядочивает по дате создания (новые сначала)

---

### 3. PATCH /api/bookings/:id/status (Изменение статуса бронирования)

**Фронтенд отправляет:**
```json
{
  "status": "approved"  // или "pending", "rejected", "cancelled", "completed"
}
```

**Бэкенд:**
- ✅ Проверяет авторизацию и роль (только ADMIN/SUPER_ADMIN)
- ✅ Преобразует строку статуса в enum
- ✅ Обновляет статус бронирования
- ✅ Отправляет уведомление в Telegram при изменении статуса

---

### 4. GET /api/users/barbers (Получение списка докторов)

**Фронтенд:**
- Публичный endpoint (не требует авторизации)
- Используется для выбора доктора при бронировании

**Бэкенд:**
- ✅ Возвращает всех докторов (роль DOCTOR)
- ✅ Убирает пароли из ответа
- ✅ Возвращает массив докторов

---

### 5. GET /api/barber (Получение default доктора)

**Фронтенд:**
- Публичный endpoint
- Используется для получения информации о докторе

**Бэкенд:**
- ✅ Возвращает default доктора (первого найденного)
- ✅ Возвращает в формате массива `[doctor]` для совместимости

---

### 6. POST /api/barber-services (Создание сервиса)

**Фронтенд отправляет:**
- FormData с полями: `name`, `price`, `image_url` (файл)
- Или JSON: `{ name, price, image_url }`

**Бэкенд:**
- ✅ Обрабатывает как FormData, так и JSON
- ✅ Автоматически устанавливает `duration: 30` минут
- ✅ Валидирует данные через Zod
- ✅ Проверяет доступность Prisma Service модели
- ✅ Возвращает понятные ошибки если модель не доступна

---

### 7. PATCH /api/users/:id/role (Изменение роли пользователя)

**Фронтенд отправляет:**
```json
{
  "role": "CLIENT"  // или "DOCTOR", "ADMIN", "SUPER_ADMIN"
}
```

**Бэкенд:**
- ✅ Улучшена обработка пустого/невалидного JSON
- ✅ Проверяет формат JSON перед парсингом
- ✅ Валидирует роль
- ✅ Проверяет права доступа (ADMIN может менять только CLIENT/DOCTOR)
- ✅ Преобразует роль в верхний регистр

**Исправления:**
- ✅ Улучшена обработка ошибок парсинга JSON
- ✅ Добавлены проверки на пустое тело запроса
- ✅ Улучшены сообщения об ошибках

---

### 8. POST /api/posts/broadcast (Отправка broadcast сообщения)

**Фронтенд отправляет:**
- FormData с полями: `title`, `description`, `image` (файл)
- Или JSON: `{ title, description, image_url }`

**Бэкенд:**
- ✅ Обрабатывает как FormData, так и JSON
- ✅ Проверяет авторизацию и роль (только ADMIN/SUPER_ADMIN)
- ✅ Находит всех клиентов с `tg_id`
- ✅ Отправляет сообщение через Telegram бота
- ✅ Поддерживает отправку с изображением

---

### 9. POST /api/auth/login (Вход в систему)

**Фронтенд отправляет:**
```json
{
  "tg_username": "super_admin",
  "password": "super_admin123"
}
```

**Бэкенд:**
- ✅ Валидирует данные через Zod
- ✅ Проверяет существование пользователя
- ✅ Проверяет роль (только ADMIN/SUPER_ADMIN могут войти через API)
- ✅ Проверяет пароль
- ✅ Генерирует JWT токен
- ✅ Возвращает токен и данные пользователя (без пароля)

---

### 10. GET /api/users (Получение всех пользователей)

**Фронтенд:**
- Требует авторизацию
- Используется в админ-панели

**Бэкенд:**
- ✅ Проверяет авторизацию
- ✅ Проверяет роль (только ADMIN/SUPER_ADMIN)
- ✅ Возвращает всех пользователей без паролей

---

## Общие улучшения

### Обработка ошибок:
- ✅ Все endpoints используют `createErrorResponse` для единообразных ошибок
- ✅ Добавлено логирование для отладки
- ✅ Улучшены сообщения об ошибках валидации

### CORS:
- ✅ Все endpoints поддерживают CORS через middleware
- ✅ В development режиме разрешены все origins

### Валидация:
- ✅ Используется Zod для валидации данных
- ✅ Улучшена нормализация данных (trim, parseInt, проверка на NaN)
- ✅ Обработка пустых значений и null

### Совместимость:
- ✅ Поддержка старых названий (`barber_id` → `doctor_id`)
- ✅ Обработка как FormData, так и JSON где необходимо
- ✅ Возврат данных в формате, ожидаемом фронтендом

---

## Рекомендации для дальнейшего улучшения:

1. **Добавить rate limiting** для защиты от злоупотреблений
2. **Улучшить логирование** - добавить структурированные логи
3. **Добавить мониторинг** - отслеживание производительности API
4. **Добавить кеширование** для часто запрашиваемых данных
5. **Добавить валидацию на фронтенде** перед отправкой запросов
